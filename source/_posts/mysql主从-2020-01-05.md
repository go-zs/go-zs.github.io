---
title: MySQL主从配置指南
date: 2020-01-05 20:38:49
tags:
---

之前一直用的阿里云上的数据库，一直没动手配置过。现在因为是TO B的公司，私有化的场景比较多，记录一下配置过程。

<!-- more -->

1. 修改配置
```
# master
# 对本地的mysql客户端的配置
[client]
default-character-set = utf8mb4

# 对其他远程连接的mysql客户端的配置
[mysql]
default-character-set = utf8mb4

# 本地mysql服务的配置
[mysqld]
character-set-client-handshake = FALSE
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

#主数据库端ID号
server_id = 1
#开启二进制日志
log-bin = mysql-bin
#需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可
binlog-do-db = rpa_license
#将从服务器从主服务器收到的更新记入到从服务器自己的二进制日志文件中
log-slave-updates
#控制binlog的写入频率。每执行多少次事务写入一次(这个参数性能消耗很大，但可减小MySQL崩溃造成的损失)
sync_binlog = 1
#这个参数一般用在主主同步中，用来错开自增值, 防止键值冲突
auto_increment_offset = 1
#这个参数一般用在主主同步中，用来错开自增值, 防止键值冲突
auto_increment_increment = 1
#二进制日志自动删除的天数，默认值为0,表示“没有自动删除”，启动时和二进制日志循环时可能删除
expire_logs_days = 7
#将函数复制到slave
log_bin_trust_function_creators = 1
```

```
# slave
server_id = 2 # 必须与主库server_id不同
log-bin = mysql-bin
log-slave-updates
sync_binlog = 0


#log buffer将每秒一次地写入log file中，并且log file的flush(刷到磁盘)操作同时进行。该模式下在事务提交的时候，不会主动触发写入磁盘的操作
innodb_flush_log_at_trx_commit = 0
#指定slave要复制哪个库
replicate-do-db = rpa_license
#MySQL主从复制的时候，当Master和Slave之间的网络中断，但是Master和Slave无法察觉的情况下（比如防火墙或者路由问题）。Slave会等待slave_net_timeout设置的秒数后，才能认为网络出现故障，然后才会重连并且追赶这段时间主库的数据
slave-net-timeout = 60
log_bin_trust_function_creators = 1

```

2. 同步两数据库数据，主mysql执行下面的命令:
`FLUSH TABLES WITH READ LOCK` 防止变更

3. GRANT ALL PRIVILEGES ON *.* TO 'root'@'172.19.76.44' IDENTIFIED BY 'rpa' WITH GRANT OPTION;


4. 进主库执行  `show master status;`， 记录 `MASTER_LOG_FILE`与`MASTER_PORT`

5. 进从库
```
stop slave;

CHANGE MASTER to MASTER_HOST='172.19.76.45', MASTER_PORT=3306, MASTER_USER='root', MASTER_PASSWORD='rpa', MASTER_LOG_FILE='mysql-bin.000002', MASTER_LOG_POS=154;

start slave;
```

6.检查从库状态
```
show slave status\G;
# Slave_IO_Running   Slave_SQL_Running 必须为 true
```
