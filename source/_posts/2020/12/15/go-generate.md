---
title: golang系列(27)--go-generate
date: 2020-12-15 09:48:05
tags:
- golang
categories:
- golang
---


`go generate`是`golang`1.4版本之后加入的命令，可以非常方便很多需要自动生成的场景。

<!-- more -->


## 基本使用

```golang
go generate [-run regexp] [-n] [-v] [-x] [build flags] [file.go... | packages]
```

其中：
* -run 正则表达式匹配命令行，仅执行匹配的命令
* -v 输出被处理的包名和源文件名
* -n 显示不执行命令
* -x 显示并执行命令

这个命令可以使用一些内置的环境变量，如：

```
$GOARCH
    体系架构 (arm、amd64等待)
$GOOS
    OS环境(linux、windows等)
$GOFILE
    当前处理中的文件名
$GOLINE
    当前命令在文件中的行号
$GOPACKAGE
    当前处理文件的包名
$DOLLAR
    固定的"$",不清楚用途
```

## stringer

介绍一个常用的使用`stringer`。

`stringer`是一个基于`go generate`自动给类型添加`String()`方法的生成工具。

```golang
func (t T) String() string
```

假设我们定义了`Pill`这个类型。

```golang
package painkiller

type Pill int

const (
	Placebo Pill = iota
	Aspirin
	Ibuprofen
	Paracetamol
	Acetaminophen = Paracetamol
)
```

运行`stringer -type=Pill`命令会生成如下的代码。

```golang
func (Pill) String() string
```

如果我们做了代码变更每次都要执行这个命令，更好的办法是添加`generate`标签。

```golang
//go:generate stringer -type=Pill

package painkiller

type Pill int

const (
	Placebo Pill = iota
	Aspirin
	Ibuprofen
	Paracetamol
	Acetaminophen = Paracetamol
)
```

然后执行`go generate`，生成`pill_string.go`文件。

```golang
// Code generated by "stringer -type=Pill"; DO NOT EDIT.

package main

import "strconv"

func _() {
	// An "invalid array index" compiler error signifies that the constant values have changed.
	// Re-run the stringer command to generate them again.
	var x [1]struct{}
	_ = x[Placebo-0]
	_ = x[Aspirin-1]
	_ = x[Ibuprofen-2]
	_ = x[Paracetamol-3]
}

const _Pill_name = "PlaceboAspirinIbuprofenParacetamol"

var _Pill_index = [...]uint8{0, 7, 14, 23, 34}

func (i Pill) String() string {
	if i < 0 || i >= Pill(len(_Pill_index)-1) {
		return "Pill(" + strconv.FormatInt(int64(i), 10) + ")"
	}
	return _Pill_name[_Pill_index[i]:_Pill_index[i+1]]
}
```