---
title: ElasticSearch配置冷热分离
date: 2019-12-13 20:45:09
updated: 2020-01-13 16:55:03
tags:
- ElasticSearch
categories:
- ElasticSearch
---

<!-- more -->


1. 部署ES集群



2. 修改节点配置：node.attr.box_type

```shell
# elasticesearch.yml 
# add
node.attr.box_type: hot   # 热数据节点
node.attr.box_type: cold  # 冷数据节点
```


3. 定义索引模板
我们可以通过指定参数`"routing.allocation.include.box_type": "hot"`，让所有符合命名规则索引的 `Shard` 都将被分配到 `Hot Nodes` 上：

```shell
# 热索引
PUT _template/active-logs
{
  "template": "active-logs-*",
  "settings": {
    "number_of_shards":   5,
    "number_of_replicas": 1,
    "routing.allocation.include.box_type": "hot",
    "routing.allocation.total_shards_per_node": 2
  },
  "aliases": {
    "active-logs":  {}
  }
}
```

同样符合命名规则索引的 Shard 会被分配到 Warm Nodes 上，我们指定了更少的 Shards 数量和复本数。

注意，这里的复本数为 0，和 best_compression 级别的压缩，方便做迁移等操作，以及进行一些数据的压缩：

```shell
# 冷索引
PUT _template/inactive-logs
{
  "template": "inactive-logs-*",
  "settings": {
    "number_of_shards":   1,
    "number_of_replicas": 0,
    "routing.allocation.include.box_type": "code",
    "codec": "best_compression"
  }
}
```


4. 设置定时任务

定时执行冷热数据切换

```shell
# !/bin/bash
es="elasticsearch:9200" # es地址
yesterday=`date -d '-1days' +%Y-%m-%d`  # 根据index时间格式来，一般一天一个index
important_index="xxxxxx" # 多副本的index
migration_index=$(curl -s -XGET "${es}/_cat/indices/*-${yesterday}?h=index"  | grep -v '^\.')
# replication_index=$(curl -s -XGET "${es}/_cat/indices/*-${yesterday}?h=index"  | grep -v '^\.' | grep -Ev ${important_index})


# move hot to cold
function migration_index_to_cold(){
   for i in `echo $1` 
   do
     curl -X PUT "${es}/${i}/_settings" -H 'Content-Type: application/json' -d'{
        "index.routing.allocation.include.box_type": "cold",
        "index.blocks.write": true
     }'
   done
}

# shrink  index
function shrink_index(){
   for i in `echo $1` 
   do
     curl -X PUT "${es}/${i}/_shrink/in${i}" -H 'Content-Type: application/json' -d'{
        "number_of_shards": 1,
        "number_of_shards": 0
     }'
   done
}

# delete hot index
function delete_index(){
   for i in `echo $1` 
   do
     curl -X DELETE "${es}/${i}" 
   done
}

migration_index_to_cold "$migration_index"
shrink_index "$migration_index"
delete_index "$migration_index"
```

1. 讨论任务调度的方案设计
2. 测试私有化部署任务调度的bug
3. 修复导入dll的文件无法自动生成sdk文档的bug